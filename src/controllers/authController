import { Request, Response } from "express";
import { LoginInterface } from "../types";
import { comparePassword, ResponseService } from "../utils";
import { AuthService, UserService } from "../services";
const responseService = new ResponseService();
const userService = new UserService();
const authService = new AuthService();
export class AuthController {
  async login(req: Request, res: Response) {
    try {
      const body = req.body as LoginInterface;
      const userExists = await userService.userExists(body.email);
      if (!userExists) {
        return responseService.response({
          res,
          message: "User does't exists",
          statusCode: 404,
        });
      }
      const user = await userService.getUser(req.body);
      const passwordMatch = await comparePassword(
        user?.password as string,
        body.password
      );
      if (!passwordMatch) {
        return responseService.response({
          res,
          message: "Invalid email or password",
          statusCode: 400,
        });
      }

      const token = await authService.loginService({
        _id: user?._id.toString() as string,
        role: user?.role ?? ("user" as string),
      });
      return responseService.response({
        res,
        message: "Login Successfuly",
        statusCode: 200,
        data: token,
      });
    } catch (error) {
      const { message, stack } = error as Error;
      responseService.response({
        res,
        data: stack,
        message,
        statusCode: 500,
      });
    }
  }
}